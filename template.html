<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#343a40">
  <meta name="description" content="Aplikasi Kasir Offline First">
  <title>Title page - Kasir PWA</title>
  <!-- Manifest -->
  <link rel="manifest" href="/assets/json/manifest.json">
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/img/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/assets/img/icon-192x192.png">
  <!-- AdminLTE CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Awesomplete CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.7/awesomplete.min.css">
  <link rel="stylesheet" href="/assets/css/awesomplete.dark.css">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Offline indicator */
    .offline-indicator {
      position: relative;
      top: 0;
      left: 0;
      right: 0;
      background: #dc3545;
      color: white;
      text-align: center;
      padding: 10px;
      z-index: 9999;
      display: none;
    }
    .online-indicator {
      position: relative;
      top: 0;
      left: 0;
      right: 0;
      background: #28a745;
      color: white;
      text-align: center;
      padding: 10px;
      z-index: 9999;
      display: none;
    }
  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
<style>
  #lockScreenModal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 999999;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: white;
    text-align: center;
  }
  #lockScreenModal input {
    max-width: 200px;
    text-align: center;
    margin-top: 1rem;
  }
</style>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-0R4XFWJZ22"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0R4XFWJZ22'); // Ganti dengan ID G- Anda
</script>
</head>
<body class="hold-transition sidebar-mini dark-mode">
<!-- Offline/Online Indicators -->
<div id="offlineIndicator" class="offline-indicator">
  <i class="fas fa-wifi-slash"></i> Anda sedang offline. Data akan disimpan secara lokal.
</div>
<div id="onlineIndicator" class="online-indicator">
  <i class="fas fa-wifi"></i> Koneksi tersedia.
</div>
<div class="wrapper" id="app">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-dark">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <!-- Search -->
      <!-- Navbar Search -->
      <li class="nav-item">
        <a class="nav-link" data-widget="navbar-search" href="#" role="button">
          <i class="fas fa-search"></i>
        </a>
        <div class="navbar-search-block">
          <form class="form-inline">
            <div class="input-group input-group-sm">
              <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
              <div class="input-group-append">
                <button class="btn btn-navbar" type="submit">
                  <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </li>
      <!-- Notification -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="fas fa-bell"></i>
          <span class="badge badge-warning navbar-badge">3</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <span class="dropdown-item dropdown-header">3 Notifications</span>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-box text-warning"></i> Stok produk hampir habis
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-check-circle text-success"></i> Transaksi berhasil
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-exclamation-triangle text-danger"></i> Kesalahan sistem
          </a>
        </div>
      </li>
      <!-- Messages -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="fas fa-envelope"></i>
          <span class="badge badge-danger navbar-badge">2</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <a href="#" class="dropdown-item">
            <i class="fas fa-envelope mr-2"></i> Permintaan restok
            <span class="float-right text-muted text-sm">2 mins</span>
          </a>
        </div>
      </li>
      <!-- Tasks -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="fas fa-tasks"></i>
          <span class="badge badge-info navbar-badge">1</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <a href="#" class="dropdown-item">
            <i class="fas fa-clipboard-list mr-2"></i> Verifikasi stok
          </a>
        </div>
      </li>
      <!-- Fullscreen -->
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="toggleFullScreen()">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <!-- Profile -->
      <li class="nav-item">
        <a class="nav-link" href="profile.html"><i class="fas fa-user"></i></a>
      </li>
      <!-- Logout -->
      <li class="nav-item">
        <a class="nav-link" href="logout.html"><i class="fas fa-sign-out-alt"></i></a>
      </li>
    </ul>
  </nav>
  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="index.html" class="brand-link">
      <span class="brand-text font-weight-light">Kasir PWA</span>
    </a>
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
          <li class="nav-item"><a href="index.html" class="nav-link"><i class="nav-icon fas fa-tachometer-alt"></i><p>Dashboard</p></a></li>
          <li class="nav-item"><a href="pos.html" class="nav-link active"><i class="nav-icon fas fa-cash-register"></i><p>Kasir</p></a></li>
          <li class="nav-item"><a href="product.html" class="nav-link"><i class="nav-icon fas fa-box"></i><p>Produk</p></a></li>
          <li class="nav-item"><a href="customer.html" class="nav-link"><i class="nav-icon fas fa-users"></i><p>Pelanggan</p></a></li>
          <li class="nav-item"><a href="report.html" class="nav-link"><i class="nav-icon fas fa-chart-line"></i><p>Laporan</p></a></li>
          <li class="nav-item"><a href="setting.html" class="nav-link"><i class="nav-icon fas fa-cog"></i><p>Pengaturan</p></a></li>
        </ul>
      </nav>
    </div>
  </aside>
  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1><i class="fas fa-cash-register"></i> Title Page</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="index.html">Home</a></li>
              <li class="breadcrumb-item active">Title page</li>
            </ol>
          </div>
        </div>
      </div>
    </section>
    <!-- Main Content -->
    <section class="content">
      <div class="container-fluid">
		<div class="row">
		  <div class="col-md-12">
		    <div class="card card-info">
              <div class="card-header">
                <h3 class="card-title">Nama data halaman utama</h3>
              </div>
              <div class="card-body">
                <p>Isi halaman utama</p>
              </div>
            </div>
		  </div>
		</div>
      </div>
    </section>
  </div>
</div>
<!-- Service Worker Registration -->
<script>
  // Register service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/assets/js/service-worker.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        })
        .catch(function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
    });
  }
  // Network status monitoring
  function updateOnlineStatus() {
    const offlineIndicator = document.getElementById('offlineIndicator');
    const onlineIndicator = document.getElementById('onlineIndicator');
    if (navigator.onLine) {
      offlineIndicator.style.display = 'none';
      onlineIndicator.style.display = 'block';
      setTimeout(() => {
        onlineIndicator.style.display = 'none';
      }, 3000);
    } else {
      offlineIndicator.style.display = 'block';
    }
  }
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus(); // Initial check
</script>
<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.0/dist/pouchdb.min.js"></script>
<!-- html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Howler.js for audio (beep) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
<script>
// Inisialisasi PouchDB dengan sync ke remote database (jika tersedia)
const localDB = new PouchDB('template_db');
const remoteDB = new PouchDB('https://couchdb.test/template_db'); // Ganti dengan URL CouchDB Anda

// Sync database (offline-first)
function syncDatabases() {
  if (navigator.onLine) {
    localDB.sync(remoteDB)
      .on('complete', function () {
        console.log('Sync completed');
      })
      .on('error', function (err) {
        console.log('Sync error:', err);
      });
  }
}

// Sync saat online
window.addEventListener('online', syncDatabases);

function toggleFullScreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    }
  }
}
  
// Inisialisasi database lokal
const notificationDB = new PouchDB('notification_db');
const remoteNotificationDB = new PouchDB('https://couchdb.test/notification_db');
const messageDB = new PouchDB('message_db');
const remoteMessageDB = new PouchDB('https://couchdb.test/message_db');
const taskDB = new PouchDB('task_db');
const remoteTaskDB = new PouchDB('https://couchdb.test/task_db');

// Fungsi untuk memperbarui tampilan notifikasi, pesan, dan task
async function updateNavbarIndicators() {
  try {
    // --- NOTIFICATIONS ---
    const unreadNotifs = await notificationDB.query('notifications/unread', {
      include_docs: true,
      descending: true,
      limit: 10
    });
    const notifCount = unreadNotifs.rows.length;
    document.querySelector('.navbar-badge.fa-bell')?.closest('a').querySelector('.navbar-badge').textContent = notifCount;
    document.querySelector('.navbar-badge.fa-bell')?.closest('a').querySelector('.navbar-badge').style.display = notifCount > 0 ? 'inline' : 'none';

    let notifHtml = notifCount > 0
      ? `<span class="dropdown-item dropdown-header">${notifCount} Notifications</span><div class="dropdown-divider"></div>`
      : `<span class="dropdown-item dropdown-header">Tidak ada notifikasi</span>`;

    for (const row of unreadNotifs.rows) {
      const doc = row.doc;
      const iconClass = doc.icon || 'fas fa-bell';
      const colorClass = doc.category === 'stock_warning' ? 'text-warning' :
                         doc.category === 'sync_error' ? 'text-danger' :
                         doc.category === 'transaction_success' ? 'text-success' : 'text-info';
      notifHtml += `
        <a href="#" class="dropdown-item mark-as-read" data-id="${doc._id}" data-db="notification">
          <i class="${iconClass} ${colorClass}"></i> ${doc.message}
        </a>
        <div class="dropdown-divider"></div>`;
    }
    document.querySelector('.dropdown-menu-lg.dropdown-menu-right').innerHTML = notifHtml;

    // --- MESSAGES ---
    const unreadMsgs = await messageDB.query('messages/unread_to_user', {
      include_docs: true,
      descending: true,
      limit: 5
    });
    const msgCount = unreadMsgs.rows.length;
    document.querySelector('.navbar-badge.fa-envelope')?.closest('a').querySelector('.navbar-badge').textContent = msgCount;
    document.querySelector('.navbar-badge.fa-envelope')?.closest('a').querySelector('.navbar-badge').style.display = msgCount > 0 ? 'inline' : 'none';

    let msgHtml = '';
    for (const row of unreadMsgs.rows) {
      const doc = row.doc;
      const timeAgo = formatTimeAgo(new Date(doc.createdAt));
      msgHtml += `
        <a href="#" class="dropdown-item mark-as-read" data-id="${doc._id}" data-db="message">
          <i class="fas fa-envelope mr-2"></i> ${doc.subject}
          <span class="float-right text-muted text-sm">${timeAgo}</span>
        </a>`;
    }
    if (msgCount === 0) {
      msgHtml = '<a href="#" class="dropdown-item">Tidak ada pesan baru</a>';
    }
    document.querySelectorAll('.dropdown-menu-lg.dropdown-menu-right')[1].innerHTML = msgHtml;

    // --- TASKS ---
    const pendingTasks = await taskDB.query('tasks/pending_tasks', {
      include_docs: true,
      descending: true,
      limit: 5
    });
    const taskCount = pendingTasks.rows.length;
    document.querySelector('.navbar-badge.fa-tasks')?.closest('a').querySelector('.navbar-badge').textContent = taskCount;
    document.querySelector('.navbar-badge.fa-tasks')?.closest('a').querySelector('.navbar-badge').style.display = taskCount > 0 ? 'inline' : 'none';

    let taskHtml = '';
    for (const row of pendingTasks.rows) {
      const doc = row.doc;
      taskHtml += `
        <a href="#" class="dropdown-item mark-task-done" data-id="${doc._id}">
          <i class="fas fa-clipboard-list mr-2"></i> ${doc.title}
        </a>`;
    }
    if (taskCount === 0) {
      taskHtml = '<a href="#" class="dropdown-item">Tidak ada tugas tertunda</a>';
    }
    document.querySelectorAll('.dropdown-menu-lg.dropdown-menu-right')[2].innerHTML = taskHtml;

  } catch (err) {
    console.error('Error updating navbar indicators:', err);
  }
}

// Helper: Format waktu relatif (misal: "2 mins ago")
function formatTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  let interval = seconds / 31536000;
  if (interval > 1) return Math.floor(interval) + " tahun lalu";
  interval = seconds / 2592000;
  if (interval > 1) return Math.floor(interval) + " bulan lalu";
  interval = seconds / 86400;
  if (interval > 1) return Math.floor(interval) + " hari lalu";
  interval = seconds / 3600;
  if (interval > 1) return Math.floor(interval) + " jam lalu";
  interval = seconds / 60;
  if (interval > 1) return Math.floor(interval) + " menit lalu";
  return "baru saja";
}

// Event: Tandai sebagai dibaca (notifikasi & pesan)
document.addEventListener('click', async function(e) {
  if (e.target.closest('.mark-as-read')) {
    e.preventDefault();
    const el = e.target.closest('.mark-as-read');
    const id = el.dataset.id;
    const dbType = el.dataset.db;

    try {
      let db, doc;
      if (dbType === 'notification') {
        doc = await notificationDB.get(id);
        doc.read = true;
        await notificationDB.put(doc);
      } else if (dbType === 'message') {
        doc = await messageDB.get(id);
        doc.read = true;
        await messageDB.put(doc);
      }

      // Tambahkan tanda centang di UI
      const icon = document.createElement('i');
      icon.className = 'fas fa-check-circle text-success ml-2';
      el.appendChild(icon);

      // Refresh badge setelah 500ms
      setTimeout(updateNavbarIndicators, 500);
    } catch (err) {
      console.error('Gagal menandai sebagai dibaca:', err);
    }
  }

  // Event: Tandai tugas selesai
  if (e.target.closest('.mark-task-done')) {
    e.preventDefault();
    const el = e.target.closest('.mark-task-done');
    const id = el.dataset.id;

    try {
      const doc = await taskDB.get(id);
      doc.status = 'completed';
      doc.completedAt = new Date().toISOString();
      await taskDB.put(doc);

      // Tambahkan tanda centang
      const icon = document.createElement('i');
      icon.className = 'fas fa-check-circle text-success ml-2';
      el.appendChild(icon);

      setTimeout(updateNavbarIndicators, 500);
    } catch (err) {
      console.error('Gagal menandai tugas selesai:', err);
    }
  }
});

// Jalankan pertama kali saat halaman dimuat
document.addEventListener('DOMContentLoaded', updateNavbarIndicators);

// Opsional: refresh tiap 30 detik
setInterval(updateNavbarIndicators, 30000);
  

async function ensureDesignDocs() {
  await notificationDB.putIfMissing({
    _id: '_design/notifications',
    views: {
      unread: {
        map: 'function(doc) { if (doc.type === "notification" && doc.read === false) emit(doc.createdAt, doc); }'
      }
    }
  });
  await messageDB.putIfMissing({
    _id: '_design/message',
    views: {
      unread: {
        map: 'function(doc) { if (doc.type === "message" && doc.read === false) emit(doc.createdAt, doc); }'
      }
    }
  });
  await taskDB.putIfMissing({
    _id: '_design/task',
    views: {
      unread: {
        map: 'function(doc) { if (doc.type === "task" && doc.read === false) emit(doc.createdAt, doc); }'
      }
    }
  });
}
</script>
<div id="lockScreenModal">
  <img src="/assets/img/icon-192x192.png" alt="Logo" width="100" class="mb-3">
  <div id="lockScreenMessage">Masukkan PIN untuk membuka</div>
  <input type="password" id="unlockPin" class="form-control" placeholder="PIN" onkeyup="if(event.key==='Enter') unlockScreen()">
</div>
<script>
let idleTime = 0;
let lockScreenConfig = JSON.parse(localStorage.getItem('lockScreenConfig'));

function showSetupLockScreen() {
  const pin = prompt("Buat PIN Lock Screen:");
  const minutes = prompt("Durasi tidak aktif (dalam menit):", "2");
  if (pin && minutes) {
    const hashedPin = md5(pin);
    const config = {
      pin: hashedPin,
      idleMinutes: parseInt(minutes),
    };
    localStorage.setItem('lockScreenConfig', JSON.stringify(config));
    lockScreenConfig = config;
    alert("Lock screen diaktifkan.");
  }
}

function resetIdleTimer() {
  idleTime = 0;
}

function lockScreen() {
  document.getElementById('lockScreenModal').style.display = 'flex';
  document.getElementById('unlockPin').focus();
}

function unlockScreen() {
  const inputPin = document.getElementById('unlockPin').value;
  if (md5(inputPin) === lockScreenConfig.pin) {
    document.getElementById('lockScreenModal').style.display = 'none';
    document.getElementById('unlockPin').value = '';
    idleTime = 0;
  } else {
    alert('PIN salah!');
  }
}

// Setup lockscreen jika belum ada
if (!lockScreenConfig) {
  showSetupLockScreen();
}

// Idle checker (setiap 1 menit)
setInterval(() => {
  idleTime++;
  if (lockScreenConfig && idleTime >= lockScreenConfig.idleMinutes) {
    lockScreen();
  }
}, 60000); // 1 menit

// Event listener: reset idle timer jika user aktif
['mousemove', 'keypress', 'click', 'scroll', 'touchstart'].forEach(evt => {
  document.addEventListener(evt, resetIdleTimer, false);
});
</script>

</body>
</html>